create database Sales

select * from User_Names
select * from sales
select * from Golduser_Signup
select * from product
select * from Users


use sales

CREATE TABLE sales(userid INTEGER,created_date DATE, product_id INTEGER);

INSERT INTO sales (userid, created_date, product_id) VALUES
(1, '2017-04-19', 2),
(3, '2019-12-18', 1),
(2, '2020-07-20', 3),
(1, '2019-10-23', 2),
(1, '2018-03-19', 3),
(3, '2016-12-20', 2),
(1, '2016-11-09', 1),
(1, '2016-05-20', 3),
(2, '2017-09-24', 1),
(1, '2017-03-11', 2),
(1, '2016-03-11', 1),
(3, '2016-11-10', 1),
(3, '2017-12-07', 2),
(3, '2016-12-15', 2),
(2, '2017-11-08', 2),
(2, '2018-09-10', 3),
(4, '2019-05-01', 1),
(5, '2018-11-23', 3),
(6, '2017-06-30', 9),
(7, '2018-08-12', 8),
(8, '2019-03-19', 7),
(9, '2017-12-04', 6),
(10, '2018-09-22', 2),
(4, '2020-08-17', 1),
(5, '2017-05-12', 10),
(6, '2014-01-27', 11),
(7, '2014-04-02', 7),
(8, '2020-12-15', 8),
(9, '2017-09-08', 8);




CREATE TABLE product (
    product_id INT PRIMARY KEY,
    product_name VARCHAR(50),
    price INT
);

INSERT INTO product (product_id, product_name, price) VALUES
(1, 'Dal Makani', 160),
(2, 'Shahi Panner', 170),
(3, 'Butter Chicken', 340),
(4, 'Aloo Gobi', 150),
(5, 'Chole Bhature', 100),
(6, 'Fish Curry', 380),
(7, 'Chicken Tikka', 300),
(8, 'Mutton Biryani', 450),
(9, 'Veg Pulao', 200),
(10, 'Mango Lassi', 80),
(11, 'Gulab Jamun', 100);


CREATE TABLE User_Names (
    userid INT PRIMARY KEY,
    names VARCHAR(50)
);

INSERT INTO User_Names (userid, names) VALUES
(1, 'Anshul'),
(2, 'Rohan'),
(3, 'Shreya'),
(4, 'Priya'),
(5, 'Aryan'),
(6, 'Sara'),
(7, 'Sahil'),
(8, 'Tanvi'),
(9, 'Ritika'),
(10, 'Gaurav');

CREATE TABLE Users (
    userid INT PRIMARY KEY,
    signup_date DATE
);

INSERT INTO Users (userid, signup_date) VALUES
(1, '2014-09-02'),
(2, '2015-01-15'),
(3, '2014-04-11'),
(4, '2015-11-17'),
(10, '2016-01-02'),
(9, '2016-01-02'),
(7, '2013-04-02'),
(8, '2013-12-15'),
(5, '2015-09-08'),
(6, '2014-07-13');


CREATE TABLE Golduser_Signup (
    userid INT PRIMARY KEY,
    signup_date DATE
);

INSERT INTO Golduser_Signup (userid, signup_date) VALUES
(1, '2014-09-02'),
(2, '2015-01-15'),
(3, '2014-04-11'),
(4, '2015-11-17'),
(10, '2016-01-02'),
(9, '2016-01-02'),
(7, '2013-04-02'),
(8, '2013-12-15'),
(5, '2015-09-08'),
(6, '2014-07-13');


	
------Q1. What is the total sales revenue generated by each product? 

SELECT s.product_id,
       p.product_name,
       COUNT(*) AS times_order,
       SUM(p.price) AS total_sales
FROM sales s
JOIN product p
  ON s.product_id = p.product_id
GROUP BY s.product_id, p.product_name
ORDER BY total_sales DESC;


-----Q2. Which 3 product has the highest sales revenue?
SELECT TOP 3 s.product_id, 
              p.product_name, 
              COUNT(*) AS times_order, 
              SUM(p.price) AS total_sales
FROM sales AS s 
INNER JOIN product AS p 
ON s.product_id = p.product_id
GROUP BY s.product_id, p.product_name
ORDER BY total_sales DESC;


-----Q3. How many users have signed up for the service and has taken the gold membership?

SELECT 
    gs.userid,
    un.names AS user_name,
    gs.signup_date AS gold_signup_date
FROM Golduser_Signup gs
INNER JOIN Users u
    ON gs.userid = u.userid
INNER JOIN User_Names un
    ON gs.userid = un.userid
ORDER BY gs.userid;


-----Q4. What is the revenue generated from gold users?

SELECT 
    s.userid,
    SUM(p.price) AS revenue
FROM sales s
JOIN Golduser_Signup g
    ON TRY_CAST(s.userid AS INT) = TRY_CAST(g.userid AS INT)
JOIN product p
    ON TRY_CAST(s.product_id AS INT) = p.product_id
GROUP BY s.userid;


-----Q5. What is the total revenue generated from gold users?

SELECT SUM(p.price) AS total_revenue
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
INNER JOIN User_Names AS u
  ON s.userid = u.userid
INNER JOIN Golduser_Signup AS gs
  ON u.userid = gs.userid;


  ------Q6. Which users has been a gold user for the How much of time?

SELECT gs.userid,
       u.names AS user_name,
       DATEDIFF(DAY, gs.signup_date, CURRENT_TIMESTAMP) AS days_as_gold_user
FROM Golduser_Signup gs
JOIN User_Names u
  ON gs.userid = u.userid;

  -------Q7. What is the most popular product among gold users?

SELECT p.product_name, 
       COUNT(s.product_id) AS times_purchased
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
INNER JOIN Golduser_Signup AS gs
  ON s.userid = gs.userid
GROUP BY p.product_name
ORDER BY times_purchased DESC;

-----Q8. What is the total sales revenue generated in each year?

SELECT YEAR(s.created_date) AS year, 
       SUM(p.price) AS total_sales_revenue
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
GROUP BY YEAR(s.created_date)
ORDER BY year ASC;

-----Q9. How has the sales revenue changed over the years?

SELECT YEAR(s.created_date) AS year, 
       SUM(p.price) AS total_sales_revenue
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
GROUP BY YEAR(s.created_date)
ORDER BY year ASC;

------Q10. What is the average Gold-signup compare to just sign up for the users?

-- Average Gold User Signups
SELECT COUNT(*) AS gold_user_signups, 
       COUNT(*) * 1.0 / (SELECT COUNT(*) FROM users) AS gold_user_signup_ratio
FROM Golduser_Signup;

-- Average General User Signups
SELECT COUNT(*) AS total_user_signups 
FROM users;


-----Q11. How many gold members users have order how many numbers of time ?

SELECT gs.userid, 
       u.names AS user_name, 
       COUNT(s.product_id) AS number_of_orders
FROM sales AS s
INNER JOIN Golduser_Signup AS gs
  ON s.userid = gs.userid
INNER JOIN User_Names AS u
  ON gs.userid = u.userid
GROUP BY gs.userid, u.names
ORDER BY number_of_orders DESC;


-------Q12. What is the total amount each customer spend on Online Food Delivery?


SELECT s.userid, 
       un.names, 
       SUM(p.price) AS total_price_spend
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
INNER JOIN User_Names AS un 
  ON un.userid = s.userid
GROUP BY s.userid, un.names;

------Q13. What is the frequency of customer visits to the online platform?

SELECT s.userid, 
       u.names AS customer_name, 
       COUNT(s.created_date) AS visit_frequency
FROM sales AS s
INNER JOIN User_Names AS u 
  ON s.userid = u.userid
GROUP BY s.userid, u.names
ORDER BY visit_frequency DESC;

------Q14. What was the first order purchase by each customer ?

WITH ranked_orders AS (
    SELECT s.userid,
           u.names AS customer_name,
           s.created_date,
           p.product_name,
           ROW_NUMBER() OVER (
               PARTITION BY s.userid
               ORDER BY s.created_date
           ) AS rn
    FROM sales s
    JOIN User_Names u ON s.userid = u.userid
    JOIN product p ON s.product_id = p.product_id
)
SELECT userid,
       customer_name,
       created_date AS first_order_date,
       product_name AS first_product
FROM ranked_orders
WHERE rn = 1;


------Q15. What is the most purchase item on the menu and how many times was it purchased by all customers?

SELECT TOP 1 p.product_name, 
             COUNT(s.product_id) AS times_purchased
FROM sales AS s
INNER JOIN product AS p 
  ON s.product_id = p.product_id
GROUP BY p.product_name
ORDER BY times_purchased DESC;

-----Q16. Which item was most popular for each customer ? 

WITH ItemPopularity AS (
    SELECT s.userid,
           u.names AS customer_name,
           p.product_name,
           COUNT(*) AS purchase_count,
           RANK() OVER (
               PARTITION BY s.userid
               ORDER BY COUNT(*) DESC
           ) AS rnk
    FROM sales s
    JOIN product p ON s.product_id = p.product_id
    JOIN User_Names u ON s.userid = u.userid
    GROUP BY s.userid, u.names, p.product_name
)
SELECT userid,
       customer_name,
       product_name AS most_popular_item,
       purchase_count
FROM ItemPopularity
WHERE rnk = 1;


-----Q17. Which item was purchase first by the customer after they become a member ?

WITH gold_orders AS (
    SELECT gs.userid,
           u.names AS customer_name,
           s.created_date,
           p.product_name,
           ROW_NUMBER() OVER (
               PARTITION BY gs.userid
               ORDER BY s.created_date
           ) AS rn
    FROM Golduser_Signup gs
    JOIN sales s
      ON gs.userid = s.userid
     AND s.created_date > gs.signup_date
    JOIN product p
      ON s.product_id = p.product_id
    JOIN User_Names u
      ON gs.userid = u.userid
)
SELECT userid,
       customer_name,
       product_name AS first_purchased_item,
       created_date AS first_purchase_date
FROM gold_orders
WHERE rn = 1;

------Q18.Which item was purchase before the customer become a member ?

SELECT gs.userid, 
       u.names AS customer_name, 
       p.product_name AS item_purchased, 
       s.created_date AS purchase_date
FROM sales AS s
INNER JOIN Golduser_Signup AS gs
  ON s.userid = gs.userid
INNER JOIN product AS p
  ON s.product_id = p.product_id
INNER JOIN User_Names AS u
  ON gs.userid = u.userid
WHERE s.created_date < gs.signup_date
ORDER BY s.created_date ASC;

------Q19. What is the total orders and amount spent for each member before they become a member ?

SELECT gs.userid, 
       u.names AS customer_name, 
       COUNT(s.product_id) AS total_orders, 
       SUM(p.price) AS total_amount_spent
FROM sales AS s
INNER JOIN Golduser_Signup AS gs
  ON s.userid = gs.userid
INNER JOIN product AS p
  ON s.product_id = p.product_id
INNER JOIN User_Names AS u
  ON gs.userid = u.userid
WHERE s.created_date < gs.signup_date
GROUP BY gs.userid, u.names
ORDER BY total_amount_spent DESC;

------Q20. Rank all the transactions for each member whenever they are a XYZ gold member for every non gold member Transaction marks as na ? 

SELECT s.userid,
       s.created_date,
       s.product_id,
       gs.signup_date,
       CASE
           WHEN gs.signup_date IS NULL THEN 'NA'
           WHEN s.created_date < gs.signup_date THEN 'NA'
           ELSE CAST(
               RANK() OVER (
                   PARTITION BY s.userid
                   ORDER BY s.created_date
               ) AS VARCHAR
           )
       END AS gold_transaction_rank
FROM sales s
LEFT JOIN Golduser_Signup gs
  ON s.userid = gs.userid;

